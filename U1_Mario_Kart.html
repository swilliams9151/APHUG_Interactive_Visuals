<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>APHG Unit 1 Kart Review</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #161b2f;
      --accent: #ffcc33;
      --accent-soft: rgba(255, 204, 51, 0.15);
      --accent-strong: #ff9f1c;
      --text: #f3f4f6;
      --muted: #9ca3af;
      --danger: #f97373;
      --success: #4ade80;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%, #000 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .game-container {
      width: 100%;
      max-width: 1000px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.97), rgba(15, 23, 42, 0.98));
      border-radius: 1.5rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.7);
      padding: 1.75rem 1.75rem 2rem;
      position: relative;
      overflow: hidden;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .title-block h1 {
      font-size: 1.7rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
    }

    .title-badge {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(253, 224, 71, 0.4);
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 0.2rem;
    }

    .status-pill {
      font-size: 0.8rem;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.25), rgba(15, 23, 42, 0.9));
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--muted);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }

    .hidden {
      display: none !important;
    }

    .section {
      margin-top: 0.5rem;
    }

    .card-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 0.75rem;
      margin-top: 0.75rem;
    }

    .card {
      background: radial-gradient(circle at top, rgba(31, 41, 55, 0.95), rgba(15, 23, 42, 0.98));
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 0.8rem 0.9rem;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(250, 204, 21, 0.22), transparent 55%);
      opacity: 0;
      transition: opacity 0.14s ease;
      pointer-events: none;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.8);
      border-color: rgba(250, 204, 21, 0.4);
    }

    .card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(250, 204, 21, 0.5), 0 16px 40px rgba(250, 204, 21, 0.35);
      background: radial-gradient(circle at top, rgba(250, 204, 21, 0.12), rgba(15, 23, 42, 0.99));
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.25rem;
    }

    .pill {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      padding: 0.55rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease, opacity 0.12s ease;
    }

    .btn-primary {
      background: radial-gradient(circle at top, var(--accent), var(--accent-strong));
      color: #1f2937;
      box-shadow: 0 10px 25px rgba(234, 179, 8, 0.55);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 40px rgba(250, 204, 21, 0.7);
    }

    .btn-secondary {
      background: rgba(31, 41, 55, 0.9);
      color: var(--muted);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.9);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Race UI */
    .race-track {
      margin-top: 1rem;
      padding: 0.9rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: radial-gradient(circle at top, rgba(30, 64, 175, 0.5), rgba(15, 23, 42, 0.96));
    }

    .race-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.55rem;
    }

    .kart-label {
      font-size: 0.8rem;
      width: 80px;
      text-align: right;
      color: var(--muted);
    }

    .progress-shell {
      flex: 1;
      height: 0.55rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      width: 0;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent-strong));
      box-shadow: 0 0 15px rgba(250, 204, 21, 0.9);
      transition: width 0.35s ease-out;
    }

    .progress-fill-rival {
      background: linear-gradient(90deg, #38bdf8, #6366f1);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.9);
    }

    .flag {
      font-size: 1.1rem;
      margin-left: 0.35rem;
    }

    .race-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.35rem;
    }

    .badge {
      font-size: 0.75rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
    }

    .badge-boost {
      border-color: rgba(74, 222, 128, 0.8);
      color: var(--success);
    }

    .badge-hit {
      border-color: rgba(248, 113, 113, 0.9);
      color: var(--danger);
    }

    .question-card {
      margin-top: 1rem;
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.97));
      padding: 0.9rem 1rem 1rem;
    }

    .question-topic {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .question-text {
      font-size: 0.95rem;
      margin-bottom: 0.65rem;
    }

    .answers-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.45rem;
      margin-top: 0.3rem;
    }

    .answer-btn {
      width: 100%;
      text-align: left;
      border-radius: 0.8rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      padding: 0.5rem 0.7rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease, transform 0.1s ease;
    }

    .answer-btn:hover {
      background: rgba(30, 64, 175, 0.7);
      transform: translateY(-1px);
    }

    .answer-btn.correct {
      border-color: rgba(74, 222, 128, 0.9);
      background: rgba(22, 163, 74, 0.2);
    }

    .answer-btn.incorrect {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(185, 28, 28, 0.2);
    }

    .feedback-text {
      font-size: 0.8rem;
      margin-top: 0.45rem;
      color: var(--muted);
    }

    .feedback-text strong {
      color: var(--accent);
      font-weight: 600;
    }

    .mini-label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.3rem;
    }

    /* Results */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
      margin-top: 0.9rem;
    }

    .results-card {
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.98));
      padding: 0.9rem 1rem;
      font-size: 0.85rem;
    }

    .results-card h3 {
      font-size: 0.95rem;
      margin-bottom: 0.4rem;
    }

    .results-stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.3rem;
    }

    .topic-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      margin: 0.07rem;
    }

    .topic-pill span {
      font-weight: 600;
    }

    .tip-list {
      margin-top: 0.3rem;
      padding-left: 1rem;
    }

    .tip-list li {
      margin-bottom: 0.22rem;
    }

    @media (min-width: 720px) {
      .answers-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .game-container {
        padding: 1.25rem 1.1rem 1.5rem;
        border-radius: 1.25rem;
      }
      .title-block h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="game-header">
      <div class="title-block">
        <h1>
          APHG Kart Review
          <span class="title-badge">Unit 1 ¬∑ Thinking Geographically</span>
        </h1>
        <p class="subtitle">Race to the finish by answering AP Human Geography questions. Correct answers = speed boosts.</p>
      </div>
      <div class="status-pill">
        <span class="status-dot"></span>
        Ready to race
      </div>
    </div>

    <!-- START SCREEN -->
    <section id="start-screen" class="section">
      <h2 style="font-size: 1.05rem; margin-bottom: 0.4rem;">Step 1 ¬∑ Choose your geographer</h2>
      <p class="mini-label">Pick a racer. Each one is just for fun&mdash;all students get the same questions.</p>
      <div class="card-row" id="character-row"></div>

      <div style="margin-top: 1.1rem;">
        <h2 style="font-size: 1.05rem; margin-bottom: 0.3rem;">Step 2 ¬∑ Choose your track</h2>
        <p class="mini-label">Each track leans toward certain Unit 1 topics.</p>
        <div class="card-row" id="track-row"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary" id="btn-quick-play">Random track</button>
        <button class="btn btn-primary" id="btn-start" disabled>
          Start race
          <span aria-hidden="true">üèÅ</span>
        </button>
      </div>
    </section>

    <!-- GAME SCREEN -->
    <section id="game-screen" class="section hidden">
      <div class="race-track">
        <div class="race-row">
          <div class="kart-label" id="player-label">You</div>
          <div class="progress-shell">
            <div class="progress-fill" id="player-progress"></div>
          </div>
          <div class="flag">üèéÔ∏è</div>
        </div>
        <div class="race-row">
          <div class="kart-label">Rival AI</div>
          <div class="progress-shell">
            <div class="progress-fill progress-fill-rival" id="rival-progress"></div>
          </div>
          <div class="flag">üöó</div>
        </div>
        <div class="race-meta">
          <div>
            <span class="badge" id="lap-info">Lap 1</span>
            <span class="badge" id="question-counter">Question 1 / 10</span>
          </div>
          <div id="boost-indicator" class="badge badge-boost hidden">Speed boost!</div>
          <div id="hit-indicator" class="badge badge-hit hidden">Obstacle hit...</div>
        </div>
      </div>

      <div class="question-card" id="question-card">
        <div class="question-topic" id="question-topic"></div>
        <div class="question-text" id="question-text"></div>
        <div class="answers-grid" id="answers-grid"></div>
        <div class="feedback-text" id="feedback-text"></div>
      </div>

      <div class="btn-row">
        <button class="btn btn-secondary" id="btn-exit">Quit race</button>
      </div>
    </section>

    <!-- RESULTS SCREEN -->
    <section id="results-screen" class="section hidden">
      <h2 style="font-size: 1.2rem; margin-bottom: 0.3rem;" id="results-title">Race results</h2>
      <p class="mini-label" id="results-subtitle"></p>

      <div class="results-grid">
        <div class="results-card">
          <h3>Scoreboard</h3>
          <div class="results-stat-row"><span>Total questions</span><span id="stat-total"></span></div>
          <div class="results-stat-row"><span>Correct</span><span id="stat-correct"></span></div>
          <div class="results-stat-row"><span>Accuracy</span><span id="stat-accuracy"></span></div>
          <div class="results-stat-row"><span>Track</span><span id="stat-track"></span></div>
          <div class="results-stat-row"><span>Character</span><span id="stat-character"></span></div>
        </div>

        <div class="results-card">
          <h3>Topic breakdown</h3>
          <div id="topic-breakdown"></div>
        </div>

        <div class="results-card">
          <h3>Suggested review tips</h3>
          <ul class="tip-list" id="review-tips"></ul>
        </div>
      </div>

      <div class="btn-row" style="margin-top: 1rem;">
        <button class="btn btn-secondary" id="btn-review-questions">See missed questions</button>
        <button class="btn btn-primary" id="btn-play-again">
          Race again
          <span aria-hidden="true">üîÅ</span>
        </button>
      </div>

      <div id="missed-questions" class="results-card hidden" style="margin-top: 0.9rem;">
        <h3>Missed questions</h3>
        <p class="mini-label">Great for a quick re-teach or individual review.</p>
        <div id="missed-list" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
      </div>
    </section>
  </div>

  <script>
    // --- DATA: CHARACTERS & TRACKS ---
    const characters = [
      {
        id: "cartographer",
        name: "The Cartographer",
        description: "Map master. Loves projections and scale.",
        tag: "Maps & scale"
      },
      {
        id: "analyst",
        name: "The Spatial Analyst",
        description: "Spots patterns and flows in an instant.",
        tag: "Patterns & processes"
      },
      {
        id: "gis",
        name: "Ms. GIS",
        description: "Data layer legend. GIS, GPS & remote sensing.",
        tag: "Geospatial tech"
      },
      {
        id: "demographer",
        name: "The Demographer",
        description: "Lives for data tables and graphs.",
        tag: "Data & analysis"
      }
    ];

    const tracks = [
      {
        id: "maps-scale",
        name: "Maps & Scale Speedway",
        focus: "Map types, projections, and map scale.",
        topicTags: ["Map Types & Scale", "Projections", "Absolute/Relative"]
      },
      {
        id: "spatial-patterns",
        name: "Spatial Patterns Circuit",
        focus: "Density, distribution, patterns, regions.",
        topicTags: ["Spatial Concepts", "Regions", "Flows"]
      },
      {
        id: "data-drive",
        name: "Data Depot Drive",
        focus: "GIS, GPS, remote sensing, qualitative vs. quantitative.",
        topicTags: ["Geospatial Tech", "Data"]
      },
      {
        id: "scale-summit",
        name: "Scale of Analysis Summit",
        focus: "Scale of analysis, global vs. local views.",
        topicTags: ["Scale of Analysis"]
      }
    ];

    // --- DATA: QUESTION BANK ---
    // Each question: { id, topic, topicGroup, trackHints, question, choices, correctIndex, rationale }
    const questionBank = [
      {
        id: 1,
        topic: "Map Types & Scale",
        topicGroup: "Map Types & Scale",
        trackHints: ["maps-scale"],
        question: "Which type of map is BEST for showing the percentage of people who are farmers in each country of the world?",
        choices: [
          "Reference map",
          "Choropleth map",
          "Dot distribution map",
          "Topographic map"
        ],
        correctIndex: 1,
        rationale: "Choropleth maps show data using colors/shading for quantities like percentages."
      },
      {
        id: 2,
        topic: "Map Scale",
        topicGroup: "Map Types & Scale",
        trackHints: ["maps-scale"],
        question: "On a map, the scale is written as 1:100,000. What does this mean?",
        choices: [
          "1 inch on the map = 100,000 inches on the ground",
          "1 mile on the map = 100,000 miles on the ground",
          "1 centimeter on the map = 100,000 miles on the ground",
          "1 meter on the map = 100,000 centimeters on the ground"
        ],
        correctIndex: 0,
        rationale: "Map scale is a ratio comparing map distance to real distance."
      },
      {
        id: 3,
        topic: "Projections",
        topicGroup: "Projections",
        trackHints: ["maps-scale"],
        question: "Which map projection is commonly used for navigation because it preserves direction but greatly distorts the size of landmasses near the poles?",
        choices: [
          "Mercator projection",
          "Robinson projection",
          "Peters projection",
          "Goode homolosine projection"
        ],
        correctIndex: 0,
        rationale: "The Mercator projection preserves direction but exaggerates size at high latitudes."
      },
      {
        id: 4,
        topic: "Projections",
        topicGroup: "Projections",
        trackHints: ["maps-scale"],
        question: "On a world map, Greenland appears almost as large as Africa, even though Africa is much bigger in real life. This is an example of distortion in which property?",
        choices: [
          "Shape",
          "Distance",
          "Size (area)",
          "Direction"
        ],
        correctIndex: 2,
        rationale: "Here the relative size (area) is distorted."
      },
      {
        id: 5,
        topic: "Absolute vs. Relative Location",
        topicGroup: "Absolute/Relative",
        trackHints: ["maps-scale", "spatial-patterns"],
        question: "Which statement is an example of relative location?",
        choices: [
          "30¬∞ N, 90¬∞ W",
          "Denham Springs is east of Baton Rouge along Interstate 12.",
          "123 Oak Street, Denham Springs, LA",
          "Elevation: 15 meters above sea level"
        ],
        correctIndex: 1,
        rationale: "Relative location describes a place compared to other places."
      },
      {
        id: 6,
        topic: "Place & Sense of Place",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A student says: 'I love our local football stadium because it reminds me of Friday night games and time with my friends.' Which geographic concept does this BEST represent?",
        choices: [
          "Site",
          "Situation",
          "Sense of place",
          "Absolute location"
        ],
        correctIndex: 2,
        rationale: "Sense of place involves emotional and personal connections."
      },
      {
        id: 7,
        topic: "Density",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "If a city has 200,000 people living in an area of 100 square kilometers, what term best describes the number of people per square kilometer?",
        choices: [
          "Concentration",
          "Density",
          "Pattern",
          "Regionalization"
        ],
        correctIndex: 1,
        rationale: "Density is the number of something per unit area."
      },
      {
        id: 8,
        topic: "Spatial Pattern",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A map shows houses in a rural area arranged mostly in a straight line along a single road. How would a geographer describe this spatial pattern?",
        choices: [
          "Random pattern",
          "Linear pattern",
          "Clustered pattern",
          "Dispersed pattern"
        ],
        correctIndex: 1,
        rationale: "Objects arranged along a line form a linear pattern."
      },
      {
        id: 9,
        topic: "Regions",
        topicGroup: "Regions",
        trackHints: ["spatial-patterns"],
        question: "'Latin America' is often described as a region where Romance languages are widely spoken. What type of region is this?",
        choices: [
          "Formal region",
          "Functional region",
          "Vernacular (perceptual) region",
          "Nodal region"
        ],
        correctIndex: 0,
        rationale: "Formal regions share a measurable trait, like language."
      },
      {
        id: 10,
        topic: "Functional Region",
        topicGroup: "Regions",
        trackHints: ["spatial-patterns"],
        question: "A metropolitan area where people commute into a central city for work is best described as which type of region?",
        choices: [
          "Formal region",
          "Functional region",
          "Vernacular region",
          "Periphery region"
        ],
        correctIndex: 1,
        rationale: "Functional regions are organized around a node, like a city."
      },
      {
        id: 11,
        topic: "Vernacular Region",
        topicGroup: "Regions",
        trackHints: ["spatial-patterns"],
        question: "Many people in the United States talk about 'the South,' even though it has no official boundaries on a map. What kind of region is 'the South'?",
        choices: [
          "Formal",
          "Functional",
          "Vernacular (perceptual)",
          "Uniform"
        ],
        correctIndex: 2,
        rationale: "Vernacular regions exist in people's perceptions."
      },
      {
        id: 12,
        topic: "Distance Decay",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns", "scale-summit"],
        question: "Distance decay refers to the idea that:",
        choices: [
          "Two places can be far apart but connected by the internet.",
          "Interaction between two places decreases as the distance between them increases.",
          "The earth's surface wears down over time.",
          "Maps become less accurate due to distortion."
        ],
        correctIndex: 1,
        rationale: "Distance decay is decreasing interaction with increasing distance."
      },
      {
        id: 13,
        topic: "Time‚ÄìSpace Compression",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns", "scale-summit"],
        question: "A music artist in South Korea releases a new song, and within hours teenagers in Louisiana are dancing to it on TikTok. Which concept does this BEST illustrate?",
        choices: [
          "Distance decay",
          "Time‚Äìspace compression",
          "Site",
          "Regionalization"
        ],
        correctIndex: 1,
        rationale: "Technology shrinks time needed for ideas to spread."
      },
      {
        id: 14,
        topic: "Diffusion",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "When people move from one country to another and bring their language with them, which type of diffusion is this?",
        choices: [
          "Hierarchical diffusion",
          "Contagious diffusion",
          "Stimulus diffusion",
          "Relocation diffusion"
        ],
        correctIndex: 3,
        rationale: "Relocation diffusion happens when people physically move."
      },
      {
        id: 15,
        topic: "Diffusion",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A new fashion trend starts with celebrities and influencers, then gradually spreads to regular consumers. What type of diffusion is this?",
        choices: [
          "Contagious diffusion",
          "Hierarchical diffusion",
          "Stimulus diffusion",
          "Relocation diffusion"
        ],
        correctIndex: 1,
        rationale: "Hierarchical diffusion spreads from important people or places first."
      },
      {
        id: 16,
        topic: "Diffusion",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A viral meme spreads rapidly across social media, and within days nearly everyone at school has seen it. What type of diffusion does this best represent?",
        choices: [
          "Contagious diffusion",
          "Hierarchical diffusion",
          "Relocation diffusion",
          "Maladaptive diffusion"
        ],
        correctIndex: 0,
        rationale: "Contagious diffusion spreads quickly to many people."
      },
      {
        id: 17,
        topic: "GIS",
        topicGroup: "Geospatial Tech",
        trackHints: ["data-drive"],
        question: "Which of the following BEST describes a Geographic Information System (GIS)?",
        choices: [
          "A system of satellites that determines absolute location",
          "A computer system that stores, analyzes, and displays geographic data in layers",
          "A network of weather stations that track storms",
          "A government agency that makes topographic maps"
        ],
        correctIndex: 1,
        rationale: "GIS is about storing and analyzing layered geographic data."
      },
      {
        id: 18,
        topic: "Remote Sensing",
        topicGroup: "Geospatial Tech",
        trackHints: ["data-drive"],
        question: "Remote sensing is most accurately described as:",
        choices: [
          "Collecting data from Earth's surface by visiting each location in person",
          "Using satellites or aircraft to collect images and data about Earth's surface",
          "Only using drones to measure elevation",
          "Recording people's opinions through online surveys"
        ],
        correctIndex: 1,
        rationale: "Remote sensing collects data from a distance, usually via satellites or aircraft."
      },
      {
        id: 19,
        topic: "GPS",
        topicGroup: "Geospatial Tech",
        trackHints: ["data-drive"],
        question: "A delivery driver uses a phone app to get step-by-step directions and to see their exact position on a map. Which technology allows this?",
        choices: [
          "GIS",
          "GPS",
          "Remote sensing",
          "Field observation"
        ],
        correctIndex: 1,
        rationale: "GPS uses satellites to determine precise location."
      },
      {
        id: 20,
        topic: "Qualitative Data",
        topicGroup: "Data",
        trackHints: ["data-drive"],
        question: "Which of the following is an example of qualitative geographic data?",
        choices: [
          "A table showing the population of each county in Louisiana",
          "A graph of average temperatures by month",
          "Interviews with residents about how they feel about new development",
          "A map showing the number of hospitals per state"
        ],
        correctIndex: 2,
        rationale: "Qualitative data focuses on descriptions and opinions."
      },
      {
        id: 21,
        topic: "Quantitative Data",
        topicGroup: "Data",
        trackHints: ["data-drive"],
        question: "A geographer maps the number of cars passing through an intersection every hour. What type of data is this?",
        choices: [
          "Qualitative",
          "Quantitative",
          "Vernacular",
          "Perceptual"
        ],
        correctIndex: 1,
        rationale: "Quantitative data is numerical."
      },
      {
        id: 22,
        topic: "Fieldwork",
        topicGroup: "Data",
        trackHints: ["data-drive"],
        question: "Students go downtown and write down observations about land use, take photos of buildings, and talk to local business owners. Which method of geographic data collection are they using?",
        choices: [
          "Remote sensing",
          "GPS tracking",
          "Field observations",
          "Online surveys"
        ],
        correctIndex: 2,
        rationale: "Field observations involve directly visiting and observing places."
      },
      {
        id: 23,
        topic: "Scale of Analysis",
        topicGroup: "Scale of Analysis",
        trackHints: ["scale-summit"],
        question: "A map shows the percentage of people living in poverty for each country in the world. What is the scale of analysis?",
        choices: [
          "Local",
          "Regional",
          "National",
          "Global"
        ],
        correctIndex: 3,
        rationale: "The map analyzes a global pattern, using countries as units."
      },
      {
        id: 24,
        topic: "Scale of Analysis",
        topicGroup: "Scale of Analysis",
        trackHints: ["scale-summit"],
        question: "A geographer makes two maps of income in the United States: one by state and one by census tract. The patterns look different on each map. This best demonstrates:",
        choices: [
          "Distance decay",
          "Scale of analysis",
          "Time‚Äìspace compression",
          "Projection distortion"
        ],
        correctIndex: 1,
        rationale: "Changing scale of analysis can change how patterns appear."
      },
      {
        id: 25,
        topic: "Human‚ÄìEnvironment Interaction",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "Which situation BEST shows human‚Äìenvironment interaction?",
        choices: [
          "Measuring the distance between two cities",
          "Using climate data to decide where to build floodwalls",
          "Giving a place a nickname",
          "Labeling latitude and longitude lines"
        ],
        correctIndex: 1,
        rationale: "Humans adapting to or modifying the environment is human‚Äìenvironment interaction."
      },
      {
        id: 26,
        topic: "Site & Situation",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A geographer studies a city's location next to a major river and several highways that connect it to other cities. This describes the city's:",
        choices: [
          "Site",
          "Situation",
          "Sense of place",
          "Absolute location"
        ],
        correctIndex: 1,
        rationale: "Situation is a place's location relative to other places and routes."
      },
      {
        id: 27,
        topic: "Site",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "Which of the following describes the site of a place?",
        choices: [
          "New Orleans is located near the mouth of the Mississippi River and is prone to flooding.",
          "New Orleans is southeast of Baton Rouge.",
          "New Orleans is known for Mardi Gras and jazz music.",
          "New Orleans is connected to other cities by I-10."
        ],
        correctIndex: 0,
        rationale: "Site describes physical characteristics like landforms and climate."
      },
      {
        id: 28,
        topic: "Spatial Pattern",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns"],
        question: "A map of a neighborhood shows houses spread far apart, each on large lots of land with fields between them. How would a geographer describe this pattern?",
        choices: [
          "Clustered",
          "Dispersed",
          "Linear",
          "Random"
        ],
        correctIndex: 1,
        rationale: "Objects spread out over an area are dispersed."
      },
      {
        id: 29,
        topic: "Flows",
        topicGroup: "Flows",
        trackHints: ["spatial-patterns"],
        question: "Trucks carry goods from a port city to warehouses and then to stores in nearby towns. In AP Human Geography, this movement is called:",
        choices: [
          "Distance decay",
          "Time‚Äìspace compression",
          "Flows",
          "Vernacular movement"
        ],
        correctIndex: 2,
        rationale: "Flows describe movement of people, goods, or ideas."
      },
      {
        id: 30,
        topic: "Map Types",
        topicGroup: "Map Types & Scale",
        trackHints: ["maps-scale"],
        question: "A map uses different-sized circles to show the total number of COVID-19 cases in each state. What type of thematic map is this?",
        choices: [
          "Dot distribution map",
          "Proportional symbol map",
          "Choropleth map",
          "Cartogram"
        ],
        correctIndex: 1,
        rationale: "Proportional symbol maps use symbol size to represent quantity."
      },
      {
        id: 35,
        topic: "GIS Application",
        topicGroup: "Geospatial Tech",
        trackHints: ["data-drive"],
        question: "A city government wants to plan safe evacuation routes for hurricanes. They combine data layers for elevation, population density, major roads, and locations of hospitals. Which geographic tool are they MOST likely using?",
        choices: [
          "GPS",
          "Remote sensing",
          "GIS",
          "Paper topographic maps"
        ],
        correctIndex: 2,
        rationale: "Combining multiple data layers is a classic GIS use."
      },
      {
        id: 36,
        topic: "Distance Decay & Time‚ÄìSpace Compression",
        topicGroup: "Spatial Concepts",
        trackHints: ["spatial-patterns", "scale-summit"],
        question: "Before modern technology, people rarely communicated with others far away because it was too slow and expensive. Today, students regularly video chat with friends on other continents. Which statement best explains how time‚Äìspace compression affects distance decay?",
        choices: [
          "Time‚Äìspace compression increases distance decay.",
          "Time‚Äìspace compression reduces the effects of distance decay by making long-distance interaction easier.",
          "Time‚Äìspace compression only affects physical distance, not communication.",
          "Time‚Äìspace compression and distance decay are unrelated."
        ],
        correctIndex: 1,
        rationale: "Technology reduces the effect of distance on interaction."
      }
    ];

    // Bonus open-ended prompts for extension (not used in scoring, but listed in review tips)
    const bonusPrompts = [
      {
        id: "B1",
        prompt: "Explain ONE way that time‚Äìspace compression has changed how ideas spread around the world."
      },
      {
        id: "B2",
        prompt: "Explain why a pattern that appears at the national scale of analysis might look different at the local scale."
      },
      {
        id: "B3",
        prompt: "Explain ONE limitation of using any flat world map (projection) to study the real Earth."
      },
      {
        id: "B4",
        prompt: "Explain why geographers might want to use BOTH quantitative and qualitative data when studying a city."
      }
    ];

    // --- STATE ---
    let selectedCharacter = null;
    let selectedTrack = null;
    let currentQuestions = [];
    let currentIndex = 0;
    let correctCount = 0;
    let playerProgress = 0;
    let rivalProgress = 0;

    const totalRaceQuestions = 10; // questions per race

    // For topic breakdown
    let topicCorrectCounts = {};
    let topicTotalCounts = {};
    let missedQuestions = [];

    // --- HELPERS ---
    function shuffleArray(arr) {
      const copy = [...arr];
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function pickQuestionsForTrack(trackId) {
      const track = tracks.find(t => t.id === trackId);
      if (!track) return shuffleArray(questionBank).slice(0, totalRaceQuestions);

      const preferredTopics = track.topicTags || [];

      const preferred = questionBank.filter(q => q.trackHints && q.trackHints.includes(trackId));
      const others = questionBank.filter(q => !q.trackHints || !q.trackHints.includes(trackId));

      let chosen = [];
      if (preferred.length >= totalRaceQuestions) {
        chosen = shuffleArray(preferred).slice(0, totalRaceQuestions);
      } else {
        const neededFromOthers = totalRaceQuestions - preferred.length;
        chosen = shuffleArray(preferred).concat(shuffleArray(others).slice(0, neededFromOthers));
      }

      return shuffleArray(chosen);
    }

    function updateProgressBars() {
      const playerBar = document.getElementById("player-progress");
      const rivalBar = document.getElementById("rival-progress");
      playerBar.style.width = Math.min(playerProgress, 100) + "%";
      rivalBar.style.width = Math.min(rivalProgress, 100) + "%";
    }

    function showIndicators(type) {
      const boost = document.getElementById("boost-indicator");
      const hit = document.getElementById("hit-indicator");
      boost.classList.add("hidden");
      hit.classList.add("hidden");
      if (type === "boost") boost.classList.remove("hidden");
      if (type === "hit") hit.classList.remove("hidden");
    }

    function resetIndicators() {
      document.getElementById("boost-indicator").classList.add("hidden");
      document.getElementById("hit-indicator").classList.add("hidden");
    }

    // --- RENDER: CHARACTERS & TRACKS ---
    function renderCharacters() {
      const row = document.getElementById("character-row");
      row.innerHTML = "";
      characters.forEach(ch => {
        const div = document.createElement("div");
        div.className = "card";
        div.dataset.id = ch.id;
        div.innerHTML = `
          <div class="card-title">${ch.name}</div>
          <p style="font-size:0.8rem;color:var(--muted);">${ch.description}</p>
          <div class="pill-row" style="margin-top:0.4rem;">
            <span class="pill">${ch.tag}</span>
          </div>
        `;
        div.addEventListener("click", () => {
          selectedCharacter = ch.id;
          [...row.children].forEach(c => c.classList.remove("selected"));
          div.classList.add("selected");
          document.getElementById("btn-start").disabled = !selectedCharacter || !selectedTrack;
        });
        row.appendChild(div);
      });
    }

    function renderTracks() {
      const row = document.getElementById("track-row");
      row.innerHTML = "";
      tracks.forEach(tr => {
        const div = document.createElement("div");
        div.className = "card";
        div.dataset.id = tr.id;
        div.innerHTML = `
          <div class="card-title">${tr.name}</div>
          <p style="font-size:0.8rem;color:var(--muted);">${tr.focus}</p>
          <div class="pill-row" style="margin-top:0.4rem;">
            ${tr.topicTags
              .map(tag => `<span class="pill">${tag}</span>`)
              .join("")}
          </div>
        `;
        div.addEventListener("click", () => {
          selectedTrack = tr.id;
          [...row.children].forEach(c => c.classList.remove("selected"));
          div.classList.add("selected");
          document.getElementById("btn-start").disabled = !selectedCharacter || !selectedTrack;
        });
        row.appendChild(div);
      });
    }

    // --- GAME FLOW ---
    function startGame() {
      if (!selectedCharacter || !selectedTrack) return;

      currentQuestions = pickQuestionsForTrack(selectedTrack);
      currentIndex = 0;
      correctCount = 0;
      playerProgress = 0;
      rivalProgress = 0;
      topicCorrectCounts = {};
      topicTotalCounts = {};
      missedQuestions = [];

      currentQuestions.forEach(q => {
        const key = q.topicGroup || q.topic;
        if (!topicTotalCounts[key]) topicTotalCounts[key] = 0;
        topicTotalCounts[key] += 1;
      });

      updateProgressBars();
      resetIndicators();

      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("results-screen").classList.add("hidden");
      document.getElementById("game-screen").classList.remove("hidden");

      const charObj = characters.find(c => c.id === selectedCharacter);
      document.getElementById("player-label").textContent = charObj ? charObj.name : "You";

      showCurrentQuestion();
    }

    function showCurrentQuestion() {
      resetIndicators();
      const q = currentQuestions[currentIndex];
      if (!q) {
        endGame();
        return;
      }

      const topicEl = document.getElementById("question-topic");
      const textEl = document.getElementById("question-text");
      const answersEl = document.getElementById("answers-grid");
      const feedbackEl = document.getElementById("feedback-text");

      topicEl.textContent = q.topicGroup ? q.topicGroup.toUpperCase() : (q.topic || "Question");
      textEl.textContent = q.question;
      answersEl.innerHTML = "";
      feedbackEl.textContent = "";

      const qNum = currentIndex + 1;
      const total = currentQuestions.length;
      document.getElementById("question-counter").textContent = `Question ${qNum} / ${total}`;
      document.getElementById("lap-info").textContent = `Lap ${Math.min(3, Math.ceil((qNum / total) * 3))}`;

      q.choices.forEach((choiceText, idx) => {
        const btn = document.createElement("button");
        btn.className = "answer-btn";
        btn.textContent = choiceText;
        btn.addEventListener("click", () => handleAnswer(idx));
        answersEl.appendChild(btn);
      });
    }

    function handleAnswer(selectedIndex) {
      const q = currentQuestions[currentIndex];
      if (!q) return;

      const answersEl = document.getElementById("answers-grid");
      const feedbackEl = document.getElementById("feedback-text");

      const buttons = [...answersEl.children];
      buttons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === q.correctIndex) btn.classList.add("correct");
        if (idx === selectedIndex && idx !== q.correctIndex) btn.classList.add("incorrect");
      });

      const correct = selectedIndex === q.correctIndex;
      const topicKey = q.topicGroup || q.topic;
      if (!topicCorrectCounts[topicKey]) topicCorrectCounts[topicKey] = 0;

      if (correct) {
        correctCount += 1;
        topicCorrectCounts[topicKey] += 1;
        feedbackEl.innerHTML = `<strong>Correct!</strong> ${q.rationale || "Nice job."}`;
        playerProgress += 16;
        rivalProgress += 10 + Math.random() * 4;
        showIndicators("boost");
      } else {
        missedQuestions.push(q);
        feedbackEl.innerHTML = `<strong>Not quite.</strong> ${q.rationale || "Review this concept."}`;
        playerProgress += 7;
        rivalProgress += 14 + Math.random() * 4;
        showIndicators("hit");
      }

      updateProgressBars();

      const total = currentQuestions.length;
      const isLast = currentIndex >= total - 1;
      const playerDone = playerProgress >= 100;
      const rivalDone = rivalProgress >= 100;

      setTimeout(() => {
        if (isLast || playerDone || rivalDone) {
          endGame();
        } else {
          currentIndex += 1;
          showCurrentQuestion();
        }
      }, 1000);
    }

    function endGame() {
      document.getElementById("game-screen").classList.add("hidden");
      document.getElementById("results-screen").classList.remove("hidden");

      const total = currentQuestions.length;
      const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;

      const resultsTitle = document.getElementById("results-title");
      const resultsSubtitle = document.getElementById("results-subtitle");

      let playerWins = false;
      if (playerProgress >= 100 && rivalProgress < 100) playerWins = true;
      else if (playerProgress > rivalProgress) playerWins = true;

      if (playerWins) {
        resultsTitle.textContent = "üèÅ You won the race!";
        resultsSubtitle.textContent = "Nice work applying Unit 1 concepts while racing.";
      } else {
        resultsTitle.textContent = "Race finished";
        resultsSubtitle.textContent = "Your rival crossed the line first this time. Use the feedback to get faster next race.";
      }

      document.getElementById("stat-total").textContent = total;
      document.getElementById("stat-correct").textContent = `${correctCount} correct`;
      document.getElementById("stat-accuracy").textContent = `${accuracy}%`;

      const trackObj = tracks.find(t => t.id === selectedTrack);
      document.getElementById("stat-track").textContent = trackObj ? trackObj.name : "Random";

      const charObj = characters.find(c => c.id === selectedCharacter);
      document.getElementById("stat-character").textContent = charObj ? charObj.name : "You";

      renderTopicBreakdown();
      renderReviewTips();
      renderMissedQuestions();
    }

    function renderTopicBreakdown() {
      const container = document.getElementById("topic-breakdown");
      container.innerHTML = "";

      Object.keys(topicTotalCounts).forEach(topic => {
        const total = topicTotalCounts[topic] || 0;
        const correct = topicCorrectCounts[topic] || 0;
        const pct = total > 0 ? Math.round((correct / total) * 100) : 0;
        const div = document.createElement("div");
        div.className = "topic-pill";
        div.innerHTML = `<span>${topic}</span> ${correct}/${total} ¬∑ ${pct}%`;
        container.appendChild(div);
      });
    }

    function renderReviewTips() {
      const list = document.getElementById("review-tips");
      list.innerHTML = "";

      // Find weakest topics by accuracy
      const topics = Object.keys(topicTotalCounts).map(topic => {
        const total = topicTotalCounts[topic] || 0;
        const correct = topicCorrectCounts[topic] || 0;
        const pct = total > 0 ? correct / total : 0;
        return { topic, total, correct, pct };
      });

      topics.sort((a, b) => a.pct - b.pct);

      const tips = [];
      if (topics.length) {
        const worst = topics[0];
        tips.push(`Review questions and notes about <strong>${worst.topic}</strong>. This was your lowest scoring topic.`);
      }
      if (topics.length > 1) {
        const second = topics[1];
        tips.push(`Try a focused practice set on <strong>${second.topic}</strong> to build more confidence.`);
      }
      if ((topicCorrectCounts["Map Types & Scale"] || 0) / (topicTotalCounts["Map Types & Scale"] || 1) < 1) {
        tips.push("Practice identifying map types (choropleth, dot, proportional symbol) and what each shows best.");
      }
      if ((topicCorrectCounts["Spatial Concepts"] || 0) / (topicTotalCounts["Spatial Concepts"] || 1) < 1) {
        tips.push("Review spatial concepts like site, situation, density, and different spatial patterns.");
      }

      // Add one open-ended bonus prompt if available
      if (bonusPrompts.length) {
        const prompt = bonusPrompts[Math.floor(Math.random() * bonusPrompts.length)];
        tips.push(`Extension: In your notebook, answer this: "${prompt.prompt}"`);
      }

      if (!tips.length) {
        tips.push("Nice work! For extra challenge, try racing again on a different track.");
      }

      tips.forEach(text => {
        const li = document.createElement("li");
        li.innerHTML = text;
        list.appendChild(li);
      });
    }

    function renderMissedQuestions() {
      const container = document.getElementById("missed-list");
      container.innerHTML = "";

      if (!missedQuestions.length) {
        container.innerHTML = "<p>You answered every question correctly. Awesome job!</p>";
        return;
      }

      missedQuestions.forEach((q, index) => {
        const wrapper = document.createElement("div");
        wrapper.style.marginBottom = "0.5rem";
        const correctChoice = q.choices[q.correctIndex];
        wrapper.innerHTML = `
          <div style="font-weight:600;margin-bottom:0.1rem;">Q${index + 1}. ${q.question}</div>
          <div style="margin-left:0.6rem;">Correct answer: <strong>${correctChoice}</strong></div>
          <div style="margin-left:0.6rem;color:var(--muted);font-size:0.8rem;">${q.rationale || "Review this idea."}</div>
        `;
        container.appendChild(wrapper);
      });
    }

    // --- EVENT LISTENERS ---
    document.getElementById("btn-start").addEventListener("click", startGame);

    document.getElementById("btn-quick-play").addEventListener("click", () => {
      // Quick random selections
      const randomChar = characters[Math.floor(Math.random() * characters.length)];
      const randomTrack = tracks[Math.floor(Math.random() * tracks.length)];
      selectedCharacter = randomChar.id;
      selectedTrack = randomTrack.id;

      // Visually select
      const charRow = document.getElementById("character-row");
      const trackRow = document.getElementById("track-row");
      [...charRow.children].forEach(c => c.classList.toggle("selected", c.dataset.id === selectedCharacter));
      [...trackRow.children].forEach(c => c.classList.toggle("selected", c.dataset.id === selectedTrack));

      document.getElementById("btn-start").disabled = false;
    });

    document.getElementById("btn-exit").addEventListener("click", () => {
      document.getElementById("game-screen").classList.add("hidden");
      document.getElementById("results-screen").classList.add("hidden");
      document.getElementById("start-screen").classList.remove("hidden");
    });

    document.getElementById("btn-play-again").addEventListener("click", () => {
      document.getElementById("results-screen").classList.add("hidden");
      document.getElementById("start-screen").classList.remove("hidden");
    });

    document.getElementById("btn-review-questions").addEventListener("click", () => {
      const box = document.getElementById("missed-questions");
      box.classList.toggle("hidden");
    });

    // --- INITIALIZE ---
    renderCharacters();
    renderTracks();
  </script>
</body>
</html>
